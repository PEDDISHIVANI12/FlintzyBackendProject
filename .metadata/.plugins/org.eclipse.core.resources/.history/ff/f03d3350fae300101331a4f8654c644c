package com.flintzy.service;



import java.time.LocalDateTime;
import java.util.Map;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.client.RestTemplate;

import com.flintzy.dto.PostRequest;
import com.flintzy.entity.FacebookPage;
import com.flintzy.entity.FacebookPost;
import com.flintzy.repo.FacebookPageRepo;
import com.flintzy.repo.FacebookPostRepo;

@Service
public class FacebookService {

    @Autowired
    private FacebookPageRepo pageRepo;
    private FacebookPostRepo postRepo;

    @PostMapping("/post")
    public ResponseEntity<?> publishPost(@RequestBody PostRequest req) {

        FacebookPage page = pageRepo.findById(req.getPageId())
                .orElseThrow(() -> new RuntimeException("Page not found"));

        String pageToken = page.getAccessToken();
        RestTemplate rest = new RestTemplate();

        String url = "https://graph.facebook.com/" + req.getPageId() +
                "/feed?message=" + req.getMessage() +
                "&access_token=" + pageToken;

        Map fbResponse = rest.postForObject(url, null, Map.class);

        String fbPostId = fbResponse.get("id").toString(); // Example "pageId_postId"

        FacebookPost post = new FacebookPost();
        post.setPageId(req.getPageId());
        post.setUserId(page.getUserId());
        post.setMessage(req.getMessage());
        post.setFacebookPostId(fbPostId);
        post.setCreatedAt(LocalDateTime.now());

        postRepo.save(post);

        return ResponseEntity.ok(fbResponse);
    }

}
