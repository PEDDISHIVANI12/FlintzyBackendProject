package com.flintzy.controller;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.multipart.MultipartFile;

import com.flintzy.dto.FacebookPageDTO;
import com.flintzy.dto.FacebookPageRequest;
import com.flintzy.dto.PostRequest;
import com.flintzy.entity.FacebookPage;
import com.flintzy.entity.FacebookPost;
import com.flintzy.entity.FacebookUser;
import com.flintzy.entity.User;
import com.flintzy.repo.FacebookPageRepo;
import com.flintzy.repo.FacebookPostRepo;
import com.flintzy.repo.FacebookUserRepo;
import com.flintzy.repo.UserRepo;
import com.flintzy.security.AESEncryptor;
import com.flintzy.service.FacebookPostingService;
import com.flintzy.service.FacebookTokenService;

import jakarta.servlet.http.HttpServletResponse;

@RestController
@RequestMapping("/facebook")
public class FacebookController {

	@Value("${facebook.app.id}")
	private String appId;

	@Value("${facebook.app.secret}")
	private String appSecret;

	@Value("${facebook.redirect.uri}")
	private String redirectUri;

	@Value("${facebook.api.version}")
	private String apiVersion;

	@Autowired
	private FacebookPageRepo pageRepo;
	@Autowired
	private FacebookPostingService postingService;
	@Autowired 
	private FacebookTokenService tokenService;
	@Autowired
	private FacebookUserRepo facebookUserRepo;
	@Autowired
	private UserRepo userRepo;
	
	private User getAuthenticatedUser() {
	    var auth = SecurityContextHolder.getContext().getAuthentication();

	    if (auth == null || auth.getPrincipal() == null) {
	        return null;
	    }

	    String email = auth.getPrincipal().toString();
	    return userRepo.findByEmail(email);
	}


	@PostMapping("/post-text")
	public ResponseEntity<?> postText(@RequestParam String pageId,
			@RequestParam String message) throws Exception {
		User user = getAuthenticatedUser();
	    if (user == null) {
	        return ResponseEntity.status(401).body("Login required");
	    }
		return ResponseEntity.ok(postingService.publishTextPost(pageId, message));
	}


	@PostMapping("/post-image")
	public ResponseEntity<?> postImage(@RequestParam String pageId,
			@RequestParam MultipartFile file,
			@RequestParam(required = false) String caption) throws Exception {

		return ResponseEntity.ok(postingService.publishImagePost(pageId, file, caption));
	}




	@GetMapping("/pages")
	public ResponseEntity<?> getPages(@AuthenticationPrincipal OAuth2User googleUser) {

		User user = getAuthenticatedUser();
	    if (user == null) {
	        return ResponseEntity.status(401).body("Login required");
	    }

	    FacebookUser fbUser = facebookUserRepo.findByAppUserId(user.getAppUserId());

	    if (fbUser == null) {
	        return ResponseEntity.status(404).body("Facebook account not connected");
	    }

		    String decryptedToken = AESEncryptor.decrypt(fbUser.getAccessToken());

		    RestTemplate rest = new RestTemplate();
		    String url = "https://graph.facebook.com/me/accounts?access_token=" + decryptedToken;
		    
		    Map<String, Object> response = rest.getForObject(url, Map.class);
		    
		    if (response.containsKey("data")) {
		        List<Map<String, Object>> data = (List<Map<String, Object>>) response.get("data");

		        for (Map<String, Object> page : data) {
		            if (page.containsKey("access_token")) {
		                page.remove("access_token");
		            }
		        }
		    }
		    return ResponseEntity.ok(response);
		

	}


	@GetMapping("/callback")
	public ResponseEntity<?> facebookCallback(
			@RequestParam("code") String code,
			@RequestParam("state") Long appUserId) {
		
		User user = getAuthenticatedUser();
	    if (user == null) {
	        return ResponseEntity.status(401).body("Login required");
	    }

		RestTemplate rest = new RestTemplate();
		String tokenUrl = "https://graph.facebook.com/" + apiVersion +
				"/oauth/access_token?" +
				"client_id=" + appId +
				"&redirect_uri=" + redirectUri +
				"&client_secret=" + appSecret +
				"&code=" + code;

		Map<String, Object> tokenResponse = rest.getForObject(tokenUrl, Map.class);

		String userAccessToken = (String) tokenResponse.get("access_token");
		System.out.print(userAccessToken);
		Object expiresInObj = tokenResponse.get("expires_in");
		Long expiresIn = 0L; 
		if (expiresInObj != null) {
			expiresIn = Long.valueOf(expiresInObj.toString());
		}
		System.out.print(expiresIn);
		String meUrl = "https://graph.facebook.com/me?fields=id,name,email&access_token=" + userAccessToken;
		Map<String, Object> meResponse = rest.getForObject(meUrl, Map.class);
		String facebookUserId = (String) meResponse.get("id");
		String encryptedToken = AESEncryptor.encrypt(userAccessToken);
		FacebookUser fbUser = facebookUserRepo.findByAppUserId(appUserId);
		LocalDateTime now = LocalDateTime.now();

		if (fbUser == null) {
			fbUser = new FacebookUser();
			fbUser.setAppUserId(appUserId);
			fbUser.setFacebookUserId(facebookUserId);
		}

		fbUser.setAccessToken(encryptedToken);
		fbUser.setExpiresIn(expiresIn);
		fbUser.setLastUpdated(now);
		fbUser.setExpiryTime(now.plusSeconds(expiresIn));

		facebookUserRepo.save(fbUser);

		return ResponseEntity.ok("Facebook connected successfully!");
	}



	@GetMapping("/login")
	public void facebookLogin(@AuthenticationPrincipal OAuth2User googleUser,
			HttpServletResponse response) throws IOException {
		
		User user = getAuthenticatedUser();
	    if (user == null) {
	        response.sendError(401, "Login required via Google first");
	        return;
	    }

	    Long appUserId = user.getAppUserId();

		String fbLoginUrl =
				"https://www.facebook.com/" + apiVersion + "/dialog/oauth?" +
						"client_id=" + appId +
						"&redirect_uri=" + redirectUri +
						"&scope=pages_show_list,pages_read_engagement,pages_manage_posts"+"&state="+appUserId;

		response.sendRedirect(fbLoginUrl);
	}


	@PostMapping("/save-pages")
	public ResponseEntity<?> savePages(@RequestBody FacebookPageRequest request) {
		
		User user = getAuthenticatedUser();
	    if (user == null) {
	        return ResponseEntity.status(401).body("Login required");
	    }


		FacebookUser fbUser = facebookUserRepo.findByAppUserId(request.getAppUserId());
		String facebookUserId = fbUser.getFacebookUserId();

		for (FacebookPageDTO p : request.getPages()) {

			FacebookPage page = pageRepo.findById(p.getPageId()).orElse(new FacebookPage());

			page.setPageId(p.getPageId());
			page.setPageName(p.getPageName());
			page.setAccessToken(AESEncryptor.encrypt(p.getAccessToken()));
			page.setAppUserId(request.getAppUserId());
			page.setFacebookUserId(facebookUserId);
			page.setLastUpdated(LocalDateTime.now());
			pageRepo.save(page);
		}

		return ResponseEntity.ok("Pages Saved");
	}

}
