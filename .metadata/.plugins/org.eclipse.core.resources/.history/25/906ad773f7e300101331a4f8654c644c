package com.flintzy.controller;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.multipart.MultipartFile;

import com.flintzy.dto.FacebookPageDTO;
import com.flintzy.dto.FacebookPageRequest;
import com.flintzy.dto.PostRequest;
import com.flintzy.entity.FacebookPage;
import com.flintzy.entity.FacebookPost;
import com.flintzy.repo.FacebookPageRepo;
import com.flintzy.repo.FacebookPostRepo;
import com.flintzy.security.AESEncryptor;
import com.flintzy.service.FacebookPostingService;
import com.flintzy.service.FacebookTokenService;

import jakarta.servlet.http.HttpServletResponse;

@RestController
@RequestMapping("/facebook")
public class FacebookController {

	@Value("${facebook.app.id}")
	private String appId;

	@Value("${facebook.app.secret}")
	private String appSecret;

	@Value("${facebook.redirect.uri}")
	private String redirectUri;

	@Value("${facebook.api.version}")
	private String apiVersion;

	@Autowired
	private FacebookPageRepo pageRepo;
	@Autowired
	private FacebookPostingService postingService;
	@Autowired 
	private FacebookTokenService tokenService;


	@PostMapping("/post-text")
	public ResponseEntity<?> postText(@RequestParam String pageId,
			@RequestParam String message) throws Exception {

		return ResponseEntity.ok(postingService.publishTextPost(pageId, message));
	}


	@PostMapping("/post-image")
	public ResponseEntity<?> postImage(@RequestParam String pageId,
			@RequestParam MultipartFile file,
			@RequestParam(required = false) String caption) throws Exception {

		return ResponseEntity.ok(postingService.publishImagePost(pageId, file, caption));
	}




@GetMapping("/pages")
public ResponseEntity<?> getPages(@RequestParam String userAccessToken) {

	RestTemplate rest = new RestTemplate();

	String url = "https://graph.facebook.com/me/accounts?access_token=" + userAccessToken;
	
	
	
	Map<String, Object> response = rest.getForObject(url, Map.class);

	return ResponseEntity.ok(response);
}


@GetMapping("/callback")
public ResponseEntity<?> facebookCallback(
        @RequestParam("code") String code,
        @RequestParam("appUserId") Long appUserId) {

    RestTemplate rest = new RestTemplate();

    // STEP 1: Exchange code for user access token
    String tokenUrl = "https://graph.facebook.com/" + apiVersion +
            "/oauth/access_token?" +
            "client_id=" + appId +
            "&redirect_uri=" + redirectUri +
            "&client_secret=" + appSecret +
            "&code=" + code;

    Map<String, Object> tokenResponse = rest.getForObject(tokenUrl, Map.class);

    String userAccessToken = (String) tokenResponse.get("access_token");
    Long expiresIn = Long.valueOf(tokenResponse.get("expires_in").toString());

    // STEP 2: Call /me to get facebookUserId
    String meUrl = "https://graph.facebook.com/me?fields=id,name,email&access_token=" + userAccessToken;

    Map<String, Object> meResponse = rest.getForObject(meUrl, Map.class);

    String facebookUserId = (String) meResponse.get("id");

    // STEP 3: Encrypt token
    String encryptedToken = AesEncryptor.encrypt(userAccessToken);

    // STEP 4: Save to facebook_users table
    FacebookUser fbUser = facebookUserRepo.findByAppUserId(appUserId);
    LocalDateTime now = LocalDateTime.now();

    if (fbUser == null) {
        fbUser = new FacebookUser();
        fbUser.setAppUserId(appUserId);
        fbUser.setFacebookUserId(facebookUserId);
    }

    fbUser.setAccessToken(encryptedToken);
    fbUser.setExpiresIn(expiresIn);
    fbUser.setLastUpdated(now);
    fbUser.setExpiryTime(now.plusSeconds(expiresIn));

    facebookUserRepo.save(fbUser);

    return ResponseEntity.ok("Facebook connected successfully!");
}



@GetMapping("/login")
public void facebookLogin(HttpServletResponse response) throws IOException {

	String fbLoginUrl =
			"https://www.facebook.com/" + apiVersion + "/dialog/oauth?" +
					"client_id=" + appId +
					"&redirect_uri=" + redirectUri +
					"&scope=pages_show_list,pages_read_engagement,pages_manage_posts";

	response.sendRedirect(fbLoginUrl);
}


@PostMapping("/save-pages")
public String savePages(@RequestBody FacebookPageRequest request) {

	for (FacebookPageDTO page : request.getPages()) {

		FacebookPage existing = pageRepo.findById(page.getPageId()).orElse(null);
		
		if(tokenService.isTokenExpired(existing)) {
			return "Please refresh the token";
		}

		else if (existing == null) {
			FacebookPage newPage = new FacebookPage();
			newPage.setPageId(page.getPageId());
			newPage.setPageName(page.getPageName());
			newPage.setAccessToken(AESEncryptor.decrypt(page.getAccessToken()));
			newPage.setUserId(request.getUserId());
			newPage.setExpiresIn(page.getExpiresIn());
			newPage.setLastUpdated(LocalDateTime.now());
			pageRepo.save(newPage);

		} else {
			existing.setAccessToken(AESEncryptor.decrypt(page.getAccessToken()));
			existing.setExpiresIn(page.getExpiresIn());
			existing.setLastUpdated(LocalDateTime.now());
			existing.setUserId(request.getUserId());
			pageRepo.save(existing);
		}
	}

	return "Pages saved successfully!";
}
}
