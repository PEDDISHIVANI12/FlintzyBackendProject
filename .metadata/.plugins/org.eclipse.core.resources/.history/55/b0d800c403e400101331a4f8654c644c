package com.flintzy.controller;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.multipart.MultipartFile;

import com.flintzy.dto.FacebookPageDTO;
import com.flintzy.dto.FacebookPageRequest;
import com.flintzy.dto.PostRequest;
import com.flintzy.entity.FacebookPage;
import com.flintzy.entity.FacebookPost;
import com.flintzy.entity.FacebookUser;
import com.flintzy.repo.FacebookPageRepo;
import com.flintzy.repo.FacebookPostRepo;
import com.flintzy.repo.FacebookUserRepo;
import com.flintzy.security.AESEncryptor;
import com.flintzy.service.FacebookPostingService;
import com.flintzy.service.FacebookTokenService;

import jakarta.servlet.http.HttpServletResponse;

@RestController
@RequestMapping("/facebook")
public class FacebookController {

	@Value("${facebook.app.id}")
	private String appId;

	@Value("${facebook.app.secret}")
	private String appSecret;

	@Value("${facebook.redirect.uri}")
	private String redirectUri;

	@Value("${facebook.api.version}")
	private String apiVersion;

	@Autowired
	private FacebookPageRepo pageRepo;
	@Autowired
	private FacebookPostingService postingService;
	@Autowired 
	private FacebookTokenService tokenService;
	@Autowired
	private FacebookUserRepo facebookUserRepo;


	@PostMapping("/post-text")
	public ResponseEntity<?> postText(@RequestParam String pageId,
			@RequestParam String message) throws Exception {

		return ResponseEntity.ok(postingService.publishTextPost(pageId, message));
	}


	@PostMapping("/post-image")
	public ResponseEntity<?> postImage(@RequestParam String pageId,
			@RequestParam MultipartFile file,
			@RequestParam(required = false) String caption) throws Exception {

		return ResponseEntity.ok(postingService.publishImagePost(pageId, file, caption));
	}




	@GetMapping("/pages")
	public ResponseEntity<?> getPages(@RequestParam Long appUserId) {

	    FacebookUser fbUser = facebookUserRepo.findByAppUserId(appUserId);

	    if (fbUser == null) {
	        return ResponseEntity.status(404).body("Facebook account not connected.");
	    }

	    
	    String decryptedUserToken = AESEncryptor.decrypt(fbUser.getAccessToken());

	    RestTemplate rest = new RestTemplate();

	    String url = "https://graph.facebook.com/me/accounts?access_token=" + decryptedUserToken;

	    Map<String, Object> pages = rest.getForObject(url, Map.class);

	    return ResponseEntity.ok(pages);
	}


@GetMapping("/callback")
public ResponseEntity<?> facebookCallback(
        @RequestParam("code") String code,
        @RequestParam("appUserId") Long appUserId) {

    RestTemplate rest = new RestTemplate();

    // STEP 1: Exchange code for user access token
    String tokenUrl = "https://graph.facebook.com/" + apiVersion +
            "/oauth/access_token?" +
            "client_id=" + appId +
            "&redirect_uri=" + redirectUri +
            "&client_secret=" + appSecret +
            "&code=" + code;

    Map<String, Object> tokenResponse = rest.getForObject(tokenUrl, Map.class);

    String userAccessToken = (String) tokenResponse.get("access_token");
    Long expiresIn = Long.valueOf(tokenResponse.get("expires_in").toString());

    // STEP 2: Call /me to get facebookUserId
    String meUrl = "https://graph.facebook.com/me?fields=id,name,email&access_token=" + userAccessToken;

    Map<String, Object> meResponse = rest.getForObject(meUrl, Map.class);

    String facebookUserId = (String) meResponse.get("id");

    // STEP 3: Encrypt token
    String encryptedToken = AESEncryptor.encrypt(userAccessToken);

    // STEP 4: Save to facebook_users table
    FacebookUser fbUser = facebookUserRepo.findByAppUserId(appUserId);
    LocalDateTime now = LocalDateTime.now();

    if (fbUser == null) {
        fbUser = new FacebookUser();
        fbUser.setAppUserId(appUserId);
        fbUser.setFacebookUserId(facebookUserId);
    }

    fbUser.setAccessToken(encryptedToken);
    fbUser.setExpiresIn(expiresIn);
    fbUser.setLastUpdated(now);
    fbUser.setExpiryTime(now.plusSeconds(expiresIn));

    facebookUserRepo.save(fbUser);

    return ResponseEntity.ok("Facebook connected successfully!");
}



@GetMapping("/login")
public void facebookLogin(HttpServletResponse response) throws IOException {

	String fbLoginUrl =
			"https://www.facebook.com/" + apiVersion + "/dialog/oauth?" +
					"client_id=" + appId +
					"&redirect_uri=" + redirectUri +
					"&scope=pages_show_list,pages_read_engagement,pages_manage_posts";

	response.sendRedirect(fbLoginUrl);
}


@PostMapping("/save-pages")
public String savePages(@RequestBody FacebookPageRequest request) {

    FacebookUser fbUser = facebookUserRepo.findByAppUserId(request.getAppUserId());
    String facebookUserId = fbUser.getFacebookUserId();

    for (FacebookPageDTO p : request.getPages()) {

        FacebookPage page = pageRepo.findById(p.getPageId()).orElse(new FacebookPage());

        page.setPageId(p.getPageId());
        page.setPageName(p.getPageName());
        page.setAccessToken(AESEncryptor.encrypt(p.getAccessToken()));
        page.setAppUserId(request.getAppUserId());
        page.setFacebookUserId(facebookUserId);
        page.setExpiresIn(p.getExpiresIn());
        page.setLastUpdated(LocalDateTime.now());
        page.setExpiryTime(LocalDateTime.now().plusSeconds(p.getExpiresIn()));

        pageRepo.save(page);
    }

    return "Pages saved";
}

}
